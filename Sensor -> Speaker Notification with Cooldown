blueprint:
  name: Sensor -> TTS on Speakers + Mobile Notify (with Cooldown)
  description: >
    When a sensor indicates occupancy, speak a TTS message on selected
    speakers and send a notification via a chosen notify service.
    Includes a cooldown so it doesn't fire too often.
  domain: automation

  input:
    trigger_sensor:
      name: Sensor to monitor
      description: Occupancy or motion sensor to trigger the alert.
      selector:
        entity: {}

    speakers:
      name: Speaker(s)
      description: One or more speakers / media_players to play the TTS.
      selector:
        entity:
          domain: media_player
          multiple: true

    notify_service:
      name: Notify service
      description: >
        The notify service to use for mobile alerts, e.g.
        'notify.mobile_app_jamies_iphone' or a group like 'notify.family'.
      default: "notify.notify"
      selector:
        text: {}

    cooldown_minutes:
      name: Cooldown (minutes)
      description: Minimum time between alerts.
      default: 5
      selector:
        number:
          min: 0
          max: 1440
          unit_of_measurement: minutes
          step: 1

    tts_message:
      name: TTS Message
      description: Message to speak on the speakers (templating allowed).
      default: "Movement detected by {{ trigger.to_state.name }}."
      selector:
        text: {}

    mobile_title:
      name: Mobile notification title
      description: Title for the push notification.
      default: "Home Assistant alert"
      selector:
        text: {}

    mobile_message:
      name: Mobile notification body
      description: Message body for the push notification (templating allowed).
      default: "Movement detected by {{ trigger.to_state.name }}."
      selector:
        text: {}

mode: single
max_exceeded: silent

variables:
  cooldown_minutes: !input cooldown_minutes
  cooldown_secs: "{{ (cooldown_minutes | int(0)) * 60 }}"

trigger:
  - platform: state
    entity_id: !input trigger_sensor

# Only continue when:
# 1) New state implies occupancy (on/detected/motion/etc.)
# 2) Cooldown has elapsed since last run
condition:
  - condition: template
    value_template: >
      {% set new = trigger.to_state.state | lower %}
      {% set occupied = ['on', 'detected', 'motion', 'occupied', 'person'] %}
      {% if new not in occupied %}
        false
      {% else %}
        {% set lt = state_attr(this.entity_id, 'last_triggered') %}
        {% if lt is none %}
          true
        {% else %}
          {{ (as_timestamp(now()) - as_timestamp(lt)) > cooldown_secs }}
        {% endif %}
      {% endif %}

action:
  # 1) Speak TTS on the selected speakers
  - service: tts.cloud_say
    target:
      entity_id: !input speakers
    data:
      message: !input tts_message

  # 2) Send mobile notification via the chosen notify service
  - service: !input notify_service
    data:
      title: !input mobile_title
      message: !input mobile_message
