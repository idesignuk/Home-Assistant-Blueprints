blueprint:
  name: Sensor -> Google Assistant Announce with Cooldown
  description: >
    Announce a message on Google Assistant speakers when occupancy is detected,
    using Google Assistant SDK broadcasts which automatically resume any
    current playback, with a cooldown between announcements.
  domain: automation

  input:
    trigger_sensor:
      name: Sensor to monitor
      description: Occupancy or motion sensor to trigger the announcement.
      selector:
        entity: {}

    media_player:
      name: (Unused) Google Cast Speaker(s)
      description: >
        Not used by this blueprint (broadcast goes to Google Assistant speakers
        via SDK). Kept for future extension.
      selector:
        entity:
          domain: media_player
          multiple: true

    cooldown_minutes:
      name: Cooldown (minutes)
      description: Minimum time between announcements.
      default: 5
      selector:
        number:
          min: 0
          max: 1440
          unit_of_measurement: minutes
          step: 1

    tts_message:
      name: Announcement Message
      description: Message to speak (templating allowed).
      default: "Movement detected by {{ trigger.to_state.name }}."
      selector:
        text: {}

mode: single
max_exceeded: silent

variables:
  cooldown_minutes: !input cooldown_minutes
  cooldown_secs: "{{ (cooldown_minutes | int(0)) * 60 }}"

trigger:
  - platform: state
    entity_id: !input trigger_sensor

condition:
  - condition: template
    value_template: >
      {% set new = trigger.to_state.state | lower %}
      {% set occupied = ['on', 'detected', 'motion', 'occupied', 'person'] %}
      {% if new not in occupied %}
        false
      {% else %}
        {% set lt = state_attr(this.entity_id, 'last_triggered') %}
        {% if lt is none %}
          true
        {% else %}
          {{ (as_timestamp(now()) - as_timestamp(lt)) > cooldown_secs }}
        {% endif %}
      {% endif %}

action:
  - service: notify.google_assistant_sdk
    data:
      message: !input tts_message
