blueprint:
  name: Sensor -> Google Assistant Announce with Cooldown
  description: >
    Announce a message on Google speakers when occupancy is detected,
    using Google Assistant SDK notifications which automatically resume
    current playback (Spotify, BBC, etc.), with cooldown support.
  domain: automation

  input:
    trigger_sensor:
      name: Sensor to monitor
      description: Occupancy or motion sensor to trigger the announcement.
      selector:
        entity: {}

    media_player:
      name: Google Cast Speaker(s)
      description: Speakers where announcements will be made.
      selector:
        entity:
          domain: media_player
          multiple: true

    cooldown_minutes:
      name: Cooldown (minutes)
      description: Minimum time between announcements
      default: 5
      selector:
        number:
          min: 0
          max: 1440
          unit_of_measurement: minutes
          step: 1

    tts_message:
      name: Announcement Message
      description: Message to speak (templating allowed).
      default: "Movement detected by {{ trigger.to_state.name }}."
      selector:
        text: {}

mode: single
max_exceeded: silent

variables:
  cooldown_secs: "{{ ( !input cooldown_minutes | int ) * 60 }}"

trigger:
  - platform: state
    entity_id: !input trigger_sensor

condition:
  - condition: template
    value_template: >
      {% set new = trigger.to_state.state | lower %}
      {% set occupied = ['on', 'detected', 'motion', 'occupied', 'person'] %}
      {% if new not in occupied %}
        false
      {% else %}
        {% set lt = state_attr(this.entity_id, 'last_triggered') %}
        {% if lt is none %}
          true
        {% else %}
          {{ (now().timestamp() - as_timestamp(lt)) > cooldown_secs }}
        {% endif %}
      {% endif %}

action:
  - service: notify.google_assistant_sdk
    data:
      message: !input tts_message

