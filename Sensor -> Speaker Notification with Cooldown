blueprint:
  name: Sensor -> Nabu Casa TTS (Google Cast Announce) with Cooldown
  description: >
    Speak a message on Google Cast speakers when a sensor indicates occupancy,
    using announcement mode so playback resumes automatically, with cooldown.
  domain: automation

  input:
    trigger_sensor:
      name: Sensor to monitor
      description: Occupancy or other sensor that triggers the notification.
      selector:
        entity: {}

    media_player:
      name: Speaker(s)
      description: Google Cast speakers for the spoken notification.
      selector:
        entity:
          domain: media_player
          multiple: true

    cooldown_minutes:
      name: Cooldown (minutes)
      description: Minimum time between announcements
      default: 5
      selector:
        number:
          min: 0
          max: 1440
          unit_of_measurement: minutes
          step: 1

    tts_message:
      name: TTS Message
      description: Message to speak when triggered (templating allowed)
      default: "The {{ trigger.to_state.name }} has been triggered."
      selector:
        text: {}

mode: single
max_exceeded: silent

variables:
  cooldown_minutes: !input cooldown_minutes
  cooldown_secs: "{{ (cooldown_minutes | int(0)) * 60 }}"

trigger:
  - platform: state
    entity_id: !input trigger_sensor

# State must imply occupancy AND cooldown must be over
condition:
  - condition: template
    value_template: >
      {% set new = trigger.to_state.state | lower %}
      {% set occupied = ['on', 'detected', 'motion', 'occupied', 'person'] %}
      {% if new not in occupied %}
        false
      {% else %}
        {% set lt = state_attr(this.entity_id, 'last_triggered') %}
        {% if lt is none %}
          true
        {% else %}
          {{ (as_timestamp(now()) - as_timestamp(lt)) > cooldown_secs }}
        {% endif %}
      {% endif %}

action:
  - service: tts.cloud_say
    target:
      entity_id: !input media_player
    data:
      message: !input tts_message
      announce: true
